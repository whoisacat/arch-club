# Workflow Pattern

### Почему эта тема

Знакомясь с архитектурными катами O'reilly Architectural Katas в нашем Клубе юного архитектора мы увидели картинку как 
на рисунке 1. 


![Рисунок 1 - Загадочные слова](https://github.com/whoisacat/arch-club/blob/workflow-article/WorkflowPattern/arch-style-choose-table.png?raw=true&sanitize=true#gh-light-mode-only)
![Рисунок 1 - Загадочные слова](https://github.com/whoisacat/arch-club/blob/workflow-article/WorkflowPattern/arch-style-choose-table-dark.png?raw=true&sanitize=true#gh-dark-mode-only)
###### Рисунок 1 - Загадочные слова

При помощи волшебной таблицы с рисунка 1 размещенной в на одном из [ресурсов](https://www.developertoarchitect.com/downloads/worksheets.html) 
без особых разъяснений авторы кат выбирали архитектурные стили для своих вариантов систем или их квант. Большинство 
понятий понятно разработчикам без особого контекста, некоторые понятны только в контексте, некоторые пришлось гуглить 
чтобы понять. Но слово workflow имеет слишком много общих смыслов и тривиальный поиск в интернете не дал результата.

![Рисунок 2 - Загадочное слово и его место в загадочных словах](https://github.com/whoisacat/arch-club/blob/workflow-article/WorkflowPattern/what-is-workflow.jpeg?raw=true&sanitize=true#gh-light-mode-only)
![Рисунок 2 - Загадочное слово и его место в загадочных словах](https://github.com/whoisacat/arch-club/blob/workflow-article/WorkflowPattern/what-is-workflow-dark.jpeg?raw=true&sanitize=true#gh-dark-mode-only)
###### Рисунок 2 - Загадочное слово и его место в загадочных словах

В книге от издательства O'reilly рассказывающей про этот шаблон объяснения слову workflow не дается тоже. Погрузившись 
в более глубокое исследование вопроса удалось найти пару статей имеющих немного проясняющих термин, об этих статьях в 
данной работе и пойдет речь.

### Что есть workflow

Исходя из контекста статей (список будет в конце работы) workflow это паттерн в области разработки программного 
обеспечения или разработки бизнес-процессов. Паттерн workflow — мощное средство моделирования бизнес-процессов. 
Мы создаем систему/компонент управления рабочим процессом, основная обязанность которого — моделировать каждое действие 
бизнес-процесса как шаг. Эта серия шагов составляет всю бизнес-логику и выполняется один за другим. Рабочий процесс 
можно рассматривать как ориентированный граф, который вызывает несколько компонентов на каждом узле/шаге для достижения 
цели системы.  
В ООП графы обычно спрятаны за специфичным "бизнес логике" поведением, в то время как workflow переносит 
все обязанности по оркестрации из основных компонентов системы в отдельный компонент, который занимается только 
определением и выполнением рабочих процессов. Выполнение всех шагов, обработка ошибок, повторных попыток и нарушений 
соглашений об уровне обслуживания являются основными системными задачами компонента управления рабочими процессами. 
Компоненты ядра системы предоставляют API-интерфейсы, предлагающие только некоторые основные возможности и не имеющие 
минимального контекста того, когда и откуда они вызываются. Большая часть «бизнес-логики» переходит в компонент 
рабочего процесса, который теперь можно использовать для объединения возможностей, предлагаемых различными базовыми 
компонентами, любым способом, которого требует бизнес.  

![Рисунок 3 - Объяснение workflow на картинке](https://github.com/whoisacat/arch-club/blob/workflow-article/WorkflowPattern/workflow-mgmt-for-orch.jpeg?raw=true&sanitize=true#gh-light-mode-only)
![Рисунок 3 - Объяснение workflow на картинке](https://github.com/whoisacat/arch-club/blob/workflow-article/WorkflowPattern/workflow-mgmt-for-orch-dark.jpeg?raw=true&sanitize=true#gh-dark-mode-only)
###### Рисунок 3 - Загадочное слово в картинках

Это особенно полезно в распределенных архитектурах, поскольку оркестрация является критически важной частью системы, и 
ни один компонент часто не может справиться с этой тяжелой задачей без слишком большой связанности с другими 
компонентами. Извлечение всей оркестрации из всех компонентов (персистентность, состояние, обработка ошибок и т. д.), 
которые оркестрируются, приводит к созданию удачно расслоенрой архитектуры «умных каналов».  
Также этот паттерн иногда называют другими именами, как Паттерн Сага (в контексте транзакций проходящих через отдельные 
компоненты системы).  

Разработка программного обеспечения испытывала потребность в архитектурных абстракциях и инструментах, организующих 
программные транзакции в рабочие процессы, которые можно определять, координировать, управлять, контролировать и 
надежно масштабировать в соответствии с бизнес-логикой. Поэтому из паттрна выросла workflow-oriented программная 
архитектура, возникшая как ответ на рост размера, сложности и количества взаимодействий различных компонентов систем. 

## Workflow ориентированная архитектура

У Workflow ориентированной архитектуры выделяют следующие компоненты:
1. Микросервисы
2. Распределенные системы
3. Паттерн коммуникации
4. Логика координации 
5. Программная парадигма

### Компоненты Workflow ориентированной архитектуры. Микросервисы

Раньше компании создавали приложения, поддерживающие централизованное управление бизнес-процессами (BPM), которое 
действует как движок для workflow. BPM затем взаимодействует со службами через систему обмена сообщениями, часто 
называемую Enterprise Service Bus (ESB). Этот шаблон разработки принадлежит к более общему стилю разработки 
программного обеспечения, называемому сервис-ориентированной архитектурой (SOA), которая была впервые разработана 
крупными поставщиками программного обеспечения (по мнению автора этой работы - для навязывания вендор лока). Однако из-за 
своих недостатков (централизованная иерархия, отсутствие интеграции CI/CD, привязка к поставщику) шаблон SOA все чаще 
становится тем решением, от которого компании хотят дистанцироваться, и именно здесь на сцену выходят микросервисы. 
Вкратце, идея микросервисов заключается в том, что приложение и бизнес-логика разбиваются на набор небольших, легких, 
автономных сервисов, которые работают вместе. Микросервисные архитектуры разработаны с целью достижения низкой 
связанности, высокой связности, эффективного использования ресурсов и целенаправленного охвата.

![Рисунок 4 - Микросервисы](https://github.com/whoisacat/arch-club/blob/workflow-article/WorkflowPattern/microservices.jpeg?raw=true&sanitize=true#gh-light-mode-only)
![Рисунок 4 - Микросервисы](https://github.com/whoisacat/arch-club/blob/workflow-article/WorkflowPattern/microservices-dark.jpeg?raw=true&sanitize=true#gh-dark-mode-only)
###### Рисунок 4 - Микросервисы

### Компоненты Workflow ориентированной архитектуры. Распределенные системы

Распределенная система — это шаблон проектирования, который включает в себя набор программных компонентов (часто 
систем хранения и вычислений), расположенных на различном количестве сетевых машинах (возможно, в нескольких регионах). 
Сетевые машины взаимодействуют и координируют свои действия для выполнения задания и достижения одного и того же 
результата. Распределенные системы обеспечивают масштабируемость, высокую производительность, балансировку нагрузки и 
отказоустойчивость, но в то же время создают такие проблемы, как согласованность, параллелизм и синхронизация часов. С 
развитием облачных услуг создание распределенных систем стало намного проще, поскольку управляемые предложения 
облачных провайдеров устранили большую часть настроек конфигурации и мер безопасности, необходимых для построения 
распределенных систем.  
Распределенные системы хранения могут быть реализованы с использованием различных шаблонов проектирования и различных 
технологий, например, с помощью кластеров HDFS, облачного хранилища и распределенных баз данных. Аналогичным образом, 
распределенные вычислительные системы также могут быть реализованы с помощью кластера Kubernetes, который организует 
контейнерные приложения, управляемые контейнерные службы и платформы распределенных вычислений.   

![Рисунок 5 - Распределенные системы](https://github.com/whoisacat/arch-club/blob/workflow-article/WorkflowPattern/decentralized.jpeg?raw=true&sanitize=true#gh-light-mode-only)
![Рисунок 5 - Распределенные системы](https://github.com/whoisacat/arch-club/blob/workflow-article/WorkflowPattern/decentralized-dark.jpeg?raw=true&sanitize=true#gh-dark-mode-only)
###### Рисунок 5 - Распределенные системы

### Компоненты Workflow ориентированной архитектуры. Паттерн коммуникации

В скоординированной Workflow системе компоненты системы не могут не иметь возможность взаимодействовать друг с другом. 
В этом отношении стоит упомянуть два шаблона связи:  
1. Первый — это шаблон синхронной блокировки, при котором один 
компонент вызывает другой компонент и блокирует его работу в ожидании ответа. Системы, разработанные с использованием 
API-интерфейсов HTTP и RESTful, являются наиболее распространенной реализацией этого шаблона.  
2. Во-втором, в асинхронном неблокирующем шаблоне компонент отправляет вызов другому компоненту, но не ожидает 
получения ответа (за исключением, возможно, подтверждающего сообщения), поэтому он может продолжать обработку других 
задач; Системы, разработанные с использованием таких брокеров сообщений, как PubSub или Apache Kafka, являются 
примерами инструментов, которые могут реализовать этот шаблон связи.

![Рисунок 6 - Паттерн коммуникации](https://github.com/whoisacat/arch-club/blob/workflow-article/WorkflowPattern/asynchr.png?raw=true&sanitize=true#gh-light-mode-only)
![Рисунок 6 - Паттерн коммуникации](https://github.com/whoisacat/arch-club/blob/workflow-article/WorkflowPattern/asynchr-dark.png?raw=true&sanitize=true#gh-dark-mode-only)
###### Рисунок 6 - Паттерн коммуникации

### Компоненты Workflow ориентированной архитектуры. Логика координации

В мультикомпонентной системе, такой как системы, основанные на рабочих процессах (workflow-based), компоненты 
взаимодействуют друг с другом по четко определенной логике, которая должна иметь смысл с технической и бизнес логикой. 
Часто существует компромисс между объемом бизнес-логики и технической надежностью систем рабочих процессов. 
Чем сложнее бизнес-логика, которую требуется реализовать в рабочем процессе, тем больше вероятность возникновения таких 
ограничений, как операционный контроль, несогласованность, параллелизм и отслеживаемость.  

![Рисунок 7 - Логика координации](https://github.com/whoisacat/arch-club/blob/workflow-article/WorkflowPattern/coord.jpg?raw=true&sanitize=true#gh-light-mode-only)
![Рисунок 7 - Логика координации](https://github.com/whoisacat/arch-club/blob/workflow-article/WorkflowPattern/coord-dark.jpg?raw=true&sanitize=true#gh-dark-mode-only)
###### Рисунок 7 - Логика координации

Помещая всю информацию о workflow в Stateful систему управления workflow, мы утяжеляем ее и делаем более функциональной, 
одновременно упрощая основные компоненты. Чтобы отследить состояние системы после очередного шага, мы не запрашиваем ни 
систему проверки, ни систему управления API, мы запрашиваем систему управления рабочими процессами о состоянии рабочего 
процесса внедрения поставщика.

### Компоненты Workflow ориентированной архитектуры. Программная парадигма

Парадигма программирования часто выбирается для представления стиля, используемого при реализации и организации решения
рабочего процесса. Среди наиболее популярных парадигм рабочих процессов — Dataflow парадигма, которая относится к
декларативной парадигме и моделирует программу как ориентированный граф или направленный ациклический граф операций
(DAG). В модели Dataflow создается граф для представления топологии исполнения, где узлы — это операции, которые могут
представлять микросервис, операцию bash, операцию базы данных или HTTP-запрос, а ребра определяют порядок и топологию
выполнения различных операций в потоке данных. Модель потока данных отличается от классических более общих программных
последовательных моделей тем, что она подчеркивает движение данных как последовательность ввода/вывода от одного шага к
другому.

![Рисунок 8 - Dataflow](https://github.com/whoisacat/arch-club/blob/workflow-article/WorkflowPattern/data-flow.png?raw=true&sanitize=true#gh-light-mode-only)
![Рисунок 8 - Dataflow](https://github.com/whoisacat/arch-club/blob/workflow-article/WorkflowPattern/data-flow-dark.png?raw=true&sanitize=true#gh-dark-mode-only)
###### Рисунок 8 - Dataflow

## Типы Workflow
Можно выделить следующте распространенные типы Workflow:
1. Extract, Transform, Load (ETL) Workflows
2. Microservice Workflows
3. Machine Learning Workflows
4. Stream Processing Workflows

### Типы Workflow. Extract, Transform, Load (ETL) Workflows

ETL, пожалуй, самый известный тип рабочих процессов. ETL — это трехэтапный процесс или конвейер, в котором данные 
извлекаются из одного или нескольких источников, преобразуются в соответствии с бизнес-логикой или структурной логикой 
и, наконец, сохраняются в целевом месте назначения. Рабочие процессы ETL распространены в области разработки данных и в 
основном представляют собой пакетные рабочие процессы, то есть они выполняются в соответствии с триггером или 
расписанием, а не непрерывно.

![Рисунок 9 - ETL](https://github.com/whoisacat/arch-club/blob/workflow-article/WorkflowPattern/etl.png?raw=true&sanitize=true#gh-light-mode-only)
![Рисунок 9 - ETL](https://github.com/whoisacat/arch-club/blob/workflow-article/WorkflowPattern/etl-dark.png?raw=true&sanitize=true#gh-dark-mode-only)
###### Рисунок 9 - ETL

### Типы Workflow. Microservice Workflows

Workflow микросервисов сложнее, в ней различные микросервисы, включающие разную бизнес-логику, координируются вместе 
для выполнения ряда операций для достижения конечной цели. Например, в интернет-магазине один микросервис может 
отвечать за подтверждение поступления заказа, другой проверяет оплату, а следующий резервирует запас до выполнения 
заказа. Рабочие процессы микросервисов во многих случаях развертываются в больших масштабах и поэтому требуют высоких 
стандартов производительности, масштабируемости и устойчивости.  
Решения для рабочих процессов на основе микросервисов пытаются добиться надежности за счет отделения определения 
рабочего процесса от реализации задачи. Это означает, что структура рабочего процесса (задачи, которые он выполняет, а 
также порядок и зависимости между ними) определяются в определении рабочего процесса (часто JSON или YAML) и выполнение 
задач происходит путем вызова соответствующего микросервиса или приложения.

![Рисунок 10 - Microservice Workflows](https://github.com/whoisacat/arch-club/blob/workflow-article/WorkflowPattern/mcs.jpg?raw=true&sanitize=true#gh-light-mode-only)
![Рисунок 10 - Microservice Workflows](https://github.com/whoisacat/arch-club/blob/workflow-article/WorkflowPattern/mcs-dark.jpg?raw=true&sanitize=true#gh-dark-mode-only)
###### Рисунок 10 - Microservice Workflows

### Типы Workflow. Machine Learning Workflows

В машинном обучении (ML) проекты часто структурируются как набор последовательных шагов, которые применяют различные 
операции к входному набору данных для создания прогнозов. Примерами операций машинного обучения являются загрузчики 
данных, преобразователи, средства оценки и предикторы. Именно такой дизайн лежит в основе программного обеспечения 
машинного обучения, такого как scikit-learn, Spark MLib, Keras и многих других. Библиотеки программного обеспечения ML 
предлагают возможность создавать рабочие процессы ML с помощью концепции конвейера, которая объединяет набор шагов, 
выполняющих различные преобразования, проверки и прогнозы.

![Рисунок 11 - ML](https://github.com/whoisacat/arch-club/blob/workflow-article/WorkflowPattern/ml.png?raw=true&sanitize=true#gh-light-mode-only)
![Рисунок 11 - ML](https://github.com/whoisacat/arch-club/blob/workflow-article/WorkflowPattern/ml-dark.png?raw=true&sanitize=true#gh-dark-mode-only)
###### Рисунок 11 - ML

### Типы Workflow. Stream Processing Workflows

В workflow потоковой передачи данных предполагается, что данные передаются в режиме реального времени, и каждое 
поступление данных обрабатывается отдельно как событие в непрерывном потоке событий. Решения для управления потоковыми 
рабочими процессами делают упор на масштабируемость, большие объемы потоков, обработку в памяти, равномерные шаблоны и 
асинхронную обработку данных. Технологии, используемые в потоковых workflow, часто относятся к семейству инструментов 
больших данных; сюда входят системы обмена сообщениями, такие как Apache Kafka или Amazon Kinesis, вычислительные 
платформы реального времени, такие как Apache Storm или Apache Spark, и распределенные базы данных, такие как Cassandra.

![Рисунок 12 - Streams](https://github.com/whoisacat/arch-club/blob/workflow-article/WorkflowPattern/spw.png?raw=true&sanitize=true#gh-light-mode-only)
![Рисунок 12 - Streams](https://github.com/whoisacat/arch-club/blob/workflow-article/WorkflowPattern/spw-dark.png?raw=true&sanitize=true#gh-dark-mode-only)
###### Рисунок 12 - Streams

## Координация Workflow: Паттерны оркестрация и хореография

В системах управления workflow и, в частности, в системах, ориентированных на микросервисы, часто встречаются концепции 
оркестрации и хореографии, поскольку они используются для описания того, как достигается координация.  
Основное различие между хореографией и оркестрацией на высоком уровне заключается в том, что оркестрация строится на 
командах, а хореография на событиях. Компонент или служба может генерировать событие или команду. Событие не знает, кто 
его подхватит и почему, ему просто все равно. Если вместо этого излучающий компонент хочет, чтобы что-то произошло, он 
отправляет не событие, а команду. Важно отметить, что команды и события характеризуются только своей семантикой, а не 
техническим протоколом. Это означает, что одна и та же технология (например, брокер обмена сообщениями) может 
использоваться для отправки событий и команд (оба являются сообщениями).

![Рисунок 13 - Streams](https://github.com/whoisacat/arch-club/blob/workflow-article/WorkflowPattern/orch-vs-choir.png?raw=true&sanitize=true#gh-light-mode-only)
![Рисунок 13 - Streams](https://github.com/whoisacat/arch-club/blob/workflow-article/WorkflowPattern/orch-vs-choir-dark.png?raw=true&sanitize=true#gh-dark-mode-only)
###### Рисунок 13 - Streams

### Координация Workflow: Оркестрация

Оркестрацию можно определить как управляемую командами систему связи, которая координирует сервисами. Мы можем думать 
об оркестрации как о подходе командования и контроля: один или несколько оркестраторов контролируют, что и когда 
происходит, и это обеспечивает хорошую степень видимости и отслеживаемости того, что происходит на уровне системы. 
Всякий раз, когда служба или компонент координирует одну или несколько служб с помощью команд, мы имеем оркестрацию.  
Еще одним важным аспектом оркестрации является то, что она необязательно должна быть централизованной. Оркестрация 
просто означает управление (или координацию) другим компонентом. Это может сделать каждый компонент; речь идет не о 
наличии центрального блока оркестратора. Тем не менее внедрение центрального координатора (оркестратора) является 
наиболее практичной и распространенной практикой оркестрации. Оркестратор — это компонент или служба, которая 
определяет порядок выполнения и запускает любые необходимые компенсирующие действия. Задействованные службы не «знают» 
(и не должны знать), что они участвуют в процессе оркестрации и принимают участие в бизнес-процессе более высокого 
уровня. Об этой цели знает только центральный координатор оркестрации, поэтому оркестрация централизована когда явно 
определены операции и порядком вызова сервисов.  

![Рисунок 14 - Оркестрация из Ньюмана](https://github.com/whoisacat/arch-club/blob/workflow-article/WorkflowPattern/orchestration-newman.png?raw=true&sanitize=true#gh-light-mode-only)
![Рисунок 14 - Оркестрация из Ньюмана](https://github.com/whoisacat/arch-club/blob/workflow-article/WorkflowPattern/orchestration-newman-dark.png?raw=true&sanitize=true#gh-dark-mode-only)
###### Рисунок 14 - Оркестрация из Ньюмана

Например, как показано на рисунке (источник: Ньюман, 2021 г.), у нас может быть центральный обработчик заказов, 
выполняющий роль оркестратора для координации процесса выполнения. Оркестратор знает, какие службы необходимы для 
выполнения операции, и решает, когда вызывать эти службы. Если вызовы завершаются неудачей, он может решить, как 
обрабатывать ошибки. В целом, оркестрованные системы, как правило, активно используют взаимодействие запрос-ответ между 
службами: обработчик заказов отправляет запрос службам (например, платежному шлюзу) и ожидает ответа, который сообщит 
ему, был ли запрос успешным, и предоставит результаты запроса.

### Координация Workflow: Хореография

В хореографии сервисы напрямую взаимодействуют друг с другом, следуя событийно-ориентированному стилю сообщения для 
достижения общей цели. Важным аспектом хореографии является то, что она фокусируется на одном звене связи, а не на 
системе в целом. Это означает, что редко имеет смысл говорить о разработке «хореографической системы».  
Каждый сервис в хореографии можно рассматривать как оркестратор взаимодействующих сервисов. Все сервисы в хореографии 
должны знать бизнес-процесс, сервисы, с которыми нужно взаимодействовать, выполняемые операции, сообщения для обмена и 
время обмена сообщениями. Хореография – это совместная работа, направленная на обмен сообщениями в общественных 
бизнес-процессах.  
Хореографическая архитектура направлена на распределение ответственности за различные задачи между несколькими 
взаимодействующими службами. Если оркестрация представляет собой подход командования и контроля, то хореографические 
системы представляют собой архитектуру «доверяй, но проверяй». Хореографические архитектуры часто интенсивно используют 
события для связи между сервисами.  

![Рисунок 15 - Хореография из Ньюмана](https://github.com/whoisacat/arch-club/blob/workflow-article/WorkflowPattern/choreography-newman.png?raw=true&sanitize=true#gh-light-mode-only)
![Рисунок 15 - Хореография из Ньюмана](https://github.com/whoisacat/arch-club/blob/workflow-article/WorkflowPattern/choreography-newman-dark.png?raw=true&sanitize=true#gh-dark-mode-only)
###### Рисунок 15 - Хореография из Ньюмана

Пример показан на рисунке (источник Newman, 2021). Когда служба склада получает первое событие «Размещение заказа», 
она знает, что ее задача — зарезервировать запасы и отправить событие, как только это будет сделано. Если товар не 
может быть получен, складу придется вызвать событие ошибки (возможно, событие «Недостаточный запас»), что может 
привести к отклонению или отмене заказа. Когда платежный шлюз создает событие «Платеж принят», оно вызывает реакцию как 
в микрослужбах лояльности, так и в микрослужбах склада. Склад в ответ отправляет посылку, а микросервис лояльности 
начисляет баллы.

## Источники:

1. Workflow-Oriented Software Architectures. Tamer Khraisha, Ph.D. August 23, 2022 https://www.linkedin.com/pulse/workflow-oriented-software-architectures-tamer-khraisha-phd/
2. Workflow pattern https://en.wikipedia.org/wiki/Workflow_pattern
3. Architecture Pattern: Orchestration via Workflows. Kislay Verma. Posted onDecember 13, 2020 https://kislayverma.com/software-architecture/architecture-pattern-orchestration-via-workflows/
4. Architecture Worksheet Downloads. ©2023 DeveloperToArchitect. https://www.developertoarchitect.com/downloads/worksheets.html
5. Achieving “five nines” in the cloud for justice and public safety. Ryan Reynolds. 17 MAR 2020. https://aws.amazon.com/blogs/publicsector/achieving-five-nines-cloud-justice-public-safety/#:~:text=The%20accepted%20availability%20standard%20for,system%20must%20work%20seamlessly%20together.
6. O'reilly Architectural Katas - Spring 2022 - Spotlight Platform. https://github.com/z-katas/arch-katas-dcc#prelude